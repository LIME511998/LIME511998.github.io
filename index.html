<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°åº¦èŠå¤©è®ºå›</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            color: #202124;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: #4285f4;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        h1 {
            margin-bottom: 5px;
        }
        
        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .content {
            padding: 20px;
        }
        
        .card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .channel-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #e8eaed;
        }
        
        .channel-tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            flex: 1;
            text-align: center;
        }
        
        .channel-tab.active {
            border-bottom-color: #4285f4;
            color: #4285f4;
            font-weight: bold;
        }
        
        .messages {
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: #ffffff;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e8eaed;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .username {
            font-weight: bold;
            color: #4285f4;
        }
        
        .timestamp {
            color: #5f6368;
        }
        
        .message-content {
            word-wrap: break-word;
        }
        
        .input-area {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        input, button {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #dadce0;
            font-size: 1rem;
        }
        
        input {
            flex: 1;
        }
        
        button {
            background: #4285f4;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #3367d6;
        }
        
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e8eaed;
        }
        
        .level-indicator {
            background: #34a853;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .voice-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .voice-btn {
            background: #34a853;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .voice-btn i {
            color: white;
            font-size: 24px;
        }
        
        .system-message {
            background: #fff8e1;
            border-left: 4px solid #ffc107;
        }
        
        .hidden {
            display: none;
        }
        
        .welcome-screen {
            text-align: center;
            padding: 40px 20px;
        }
        
        .welcome-screen h2 {
            margin-bottom: 20px;
            color: #4285f4;
        }
        
        .welcome-screen input {
            margin: 15px 0;
            text-align: center;
            width: 80%;
            max-width: 300px;
        }
        
        .welcome-screen button {
            background: #34a853;
            width: 80%;
            max-width: 300px;
        }
        
        .welcome-screen button:hover {
            background: #2e8b47;
        }
        
        .welcome-screen .error {
            color: #ea4335;
            margin-top: 10px;
            display: none;
        }
        
        @media (max-width: 600px) {
            .container {
                border-radius: 0;
            }
            
            .channel-tabs {
                flex-direction: column;
            }
            
            .channel-tab {
                border-bottom: 1px solid #e8eaed;
                border-left: 3px solid transparent;
            }
            
            .channel-tab.active {
                border-left-color: #4285f4;
                border-bottom-color: #e8eaed;
            }
            
            .input-area {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>å°åº¦èŠå¤©è®ºå›</h1>
            <p class="subtitle">ä¸»åŒº Â· èŠå¤©åŒº Â· åˆ·å±åŒº</p>
        </header>
        
        <div id="welcome-view" class="welcome-screen">
            <h2>æ¬¢è¿æ¥åˆ°å°åº¦èŠå¤©è®ºå›</h2>
            <p>è¯·è®¾ç½®æ‚¨çš„ç”¨æˆ·åï¼ŒåŠ å…¥æˆ‘ä»¬çš„èŠå¤©ç¤¾åŒº</p>
            <input type="text" id="username-input" placeholder="è¯·è¾“å…¥æ‚¨çš„ç”¨æˆ·å" maxlength="15">
            <button id="register-btn">åŠ å…¥è®ºå›</button>
            <div class="error" id="register-error">ç”¨æˆ·åä¸èƒ½ä¸ºç©ºï¼</div>
        </div>
        
        <div id="chat-view" class="content hidden">
            <div class="user-info">
                <div>
                    <span id="current-username">ç”¨æˆ·å</span>
                    <div class="level-indicator" id="level-display">Lv.1 (0/10)</div>
                </div>
                <div id="status-indicator">
                    <span>åœ¨çº¿</span>
                </div>
            </div>
            
            <div class="channel-tabs">
                <div class="channel-tab active" data-channel="main">ä¸»åŒº</div>
                <div class="channel-tab" data-channel="chat">èŠå¤©åŒº</div>
                <div class="channel-tab" data-channel="spam">åˆ·å±åŒº</div>
            </div>
            
            <div class="messages" id="messages">
                <!-- æ¶ˆæ¯å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
            
            <div class="input-area">
                <input type="text" id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯...">
                <button id="send-btn">å‘é€</button>
            </div>
            
            <div class="voice-controls">
                <div class="voice-btn" id="voice-input-btn">
                    <i>ğŸ¤</i>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç­‰çº§ç³»ç»Ÿï¼šæ¯çº§æ‰€éœ€ç»éªŒå€¼
        const levelRequirements = [0, 10, 25, 50, 100, 200, 350, 500, 700, 1000];
        
        // ä¸‰ä¸ªé¢‘é“çš„åˆå§‹æ¶ˆæ¯
        const channels = {
            main: [
                { user: "ç³»ç»Ÿ", content: "æ¬¢è¿æ¥åˆ°ä¸»åŒºï¼Œè¿™é‡Œå¯ä»¥è®¨è®ºå„ç§è¯é¢˜", time: "10:00", type: "system" }
            ],
            chat: [
                { user: "ç³»ç»Ÿ", content: "èŠå¤©åŒºï¼Œéšæ„é—²èŠ", time: "09:30", type: "system" }
            ],
            spam: [
                { user: "ç³»ç»Ÿ", content: "åˆ·å±åŒºï¼Œå¯ä»¥å¿«é€Ÿåˆ·æ¶ˆæ¯", time: "11:00", type: "system" }
            ]
        };
        
        // DOMå…ƒç´ 
        const welcomeView = document.getElementById('welcome-view');
        const chatView = document.getElementById('chat-view');
        const usernameInput = document.getElementById('username-input');
        const registerBtn = document.getElementById('register-btn');
        const registerError = document.getElementById('register-error');
        const currentUsername = document.getElementById('current-username');
        const levelDisplay = document.getElementById('level-display');
        const channelTabs = document.querySelectorAll('.channel-tab');
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const voiceInputBtn = document.getElementById('voice-input-btn');
        
        // å½“å‰çŠ¶æ€
        let currentUser = null;
        let currentChannel = 'main';
        let messageCount = 0;
        let currentLevel = 1;
        let currentExp = 0;
        let speechQueue = [];
        let isSpeaking = false;
        let hasPromptedForMessage = false;
        
        // åˆå§‹åŒ–
        function init() {
            // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„ç”¨æˆ·æ•°æ®
            const savedUser = localStorage.getItem('forumUser');
            if (savedUser) {
                const userData = JSON.parse(savedUser);
                currentUser = userData.username;
                messageCount = userData.messageCount || 0;
                currentLevel = userData.level || 1;
                currentExp = userData.exp || 0;
                
                showChatView();
                updateLevelDisplay();
                speakWelcomeMessage();
            } else {
                showWelcomeView();
            }
            
            setupEventListeners();
        }
        
        // æ˜¾ç¤ºæ¬¢è¿ç•Œé¢
        function showWelcomeView() {
            welcomeView.classList.remove('hidden');
            chatView.classList.add('hidden');
            registerError.style.display = 'none';
        }
        
        // æ˜¾ç¤ºèŠå¤©ç•Œé¢
        function showChatView() {
            welcomeView.classList.add('hidden');
            chatView.classList.remove('hidden');
            currentUsername.textContent = currentUser;
            loadChannelMessages(currentChannel);
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æ³¨å†ŒæŒ‰é’®äº‹ä»¶
            registerBtn.addEventListener('click', registerUser);
            
            // å›è½¦é”®æ³¨å†Œ
            usernameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') registerUser();
            });
            
            // é¢‘é“åˆ‡æ¢äº‹ä»¶
            channelTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰activeç±»
                    channelTabs.forEach(t => t.classList.remove('active'));
                    // æ·»åŠ activeç±»åˆ°å½“å‰æ ‡ç­¾
                    this.classList.add('active');
                    // åˆ‡æ¢é¢‘é“
                    switchChannel(this.dataset.channel);
                });
            });
            
            // å‘é€æ¶ˆæ¯äº‹ä»¶
            sendBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            
            // è¯­éŸ³è¾“å…¥äº‹ä»¶
            voiceInputBtn.addEventListener('click', startVoiceInput);
        }
        
        // ç”¨æˆ·æ³¨å†Œ
        function registerUser() {
            const username = usernameInput.value.trim();
            if (username) {
                currentUser = username;
                messageCount = 0;
                currentLevel = 1;
                currentExp = 0;
                
                // ä¿å­˜ç”¨æˆ·æ•°æ®
                localStorage.setItem('forumUser', JSON.stringify({
                    username: currentUser,
                    messageCount: messageCount,
                    level: currentLevel,
                    exp: currentExp
                }));
                
                showChatView();
                speakWelcomeMessage();
            } else {
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                registerError.style.display = 'block';
                usernameInput.style.borderColor = '#ea4335';
            }
        }
        
        // æ’­æŠ¥æ¬¢è¿æ¶ˆæ¯
        function speakWelcomeMessage() {
            const nextLevelExp = levelRequirements[currentLevel] - currentExp;
            const welcomeText = `${currentUser}ï¼Œæ¬¢è¿æ¥åˆ°è®ºå›ï¼Œæ‚¨ç›®å‰çš„ç­‰çº§ä¸º${currentLevel}çº§ï¼Œå‡åˆ°ä¸‹ä¸€çº§è¿˜éœ€${nextLevelExp}ç‚¹ç»éªŒ`;
            
            // æ·»åŠ åˆ°è¯­éŸ³é˜Ÿåˆ—
            speechQueue.push(welcomeText);
            
            // æ’­æŠ¥é¢‘é“æ¶ˆæ¯
            playChannelMessages();
            
            // å¼€å§‹å¤„ç†è¯­éŸ³é˜Ÿåˆ—
            processSpeechQueue();
        }
        
        // å¤„ç†è¯­éŸ³é˜Ÿåˆ—
        function processSpeechQueue() {
            if (speechQueue.length > 0 && !isSpeaking) {
                isSpeaking = true;
                const text = speechQueue.shift();
                
                // ä½¿ç”¨Web Speech APIæ’­æŠ¥
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'zh-CN';
                    utterance.rate = 1.0;
                    utterance.pitch = 1.0;
                    
                    utterance.onend = () => {
                        isSpeaking = false;
                        setTimeout(processSpeechQueue, 500);
                    };
                    
                    speechSynthesis.speak(utterance);
                } else {
                    // å¦‚æœä¸æ”¯æŒè¯­éŸ³åˆæˆï¼Œä½¿ç”¨alertæ¨¡æ‹Ÿ
                    alert(text);
                    isSpeaking = false;
                    setTimeout(processSpeechQueue, 1000);
                }
            } else if (speechQueue.length === 0 && !isSpeaking) {
                // æ‰€æœ‰æ¶ˆæ¯æ’­æŠ¥å®Œæ¯•ï¼Œåªæœ‰åœ¨æœªæç¤ºè¿‡æ—¶æ‰æç¤ºç•™è¨€
                if (!hasPromptedForMessage) {
                    speechQueue.push("è¯·ç•™ä¸‹ä½ çš„ç•™è¨€");
                    hasPromptedForMessage = true;
                    processSpeechQueue();
                }
            }
        }
        
        // æ’­æŠ¥é¢‘é“æ¶ˆæ¯
        function playChannelMessages() {
            const messages = channels[currentChannel];
            
            // æ¸…ç©ºè¯­éŸ³é˜Ÿåˆ—
            speechQueue = [];
            
            // æ·»åŠ é¢‘é“æ¶ˆæ¯åˆ°è¯­éŸ³é˜Ÿåˆ—
            messages.forEach(msg => {
                if (msg.type === 'system') {
                    speechQueue.push(`ç³»ç»Ÿæ¶ˆæ¯ï¼š${msg.content}`);
                } else {
                    speechQueue.push(`${msg.user}è¯´ï¼š${msg.content}`);
                }
            });
        }
        
        // åˆ‡æ¢é¢‘é“
        function switchChannel(channel) {
            currentChannel = channel;
            loadChannelMessages(channel);
            
            // æ’­æŠ¥é¢‘é“åˆ‡æ¢
            speechQueue.push(`ä½ å·²åˆ‡æ¢åˆ°${getChannelName(channel)}`);
            
            // æ’­æŠ¥é¢‘é“æ¶ˆæ¯
            playChannelMessages();
            processSpeechQueue();
        }
        
        // è·å–é¢‘é“åç§°
        function getChannelName(channel) {
            switch(channel) {
                case 'main': return 'ä¸»åŒº';
                case 'chat': return 'èŠå¤©åŒº';
                case 'spam': return 'åˆ·å±åŒº';
                default: return 'æœªçŸ¥åŒºåŸŸ';
            }
        }
        
        // åŠ è½½é¢‘é“æ¶ˆæ¯
        function loadChannelMessages(channel) {
            messagesContainer.innerHTML = '';
            const messages = channels[channel];
            
            messages.forEach(msg => {
                addMessageToDOM(msg.user, msg.content, msg.time, msg.type);
            });
        }
        
        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message) {
                // æ·»åŠ åˆ°å½“å‰é¢‘é“
                addMessageToChannel(currentChannel, currentUser, message);
                
                // æ·»åŠ åˆ°DOM
                const now = new Date();
                const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                addMessageToDOM(currentUser, message, timeString, 'user');
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                messageInput.value = '';
                
                // å¢åŠ ç»éªŒå€¼
                currentExp++;
                messageCount++;
                
                // æ£€æŸ¥ç­‰çº§æå‡
                checkLevelUp();
                
                // æ›´æ–°æ˜¾ç¤º
                updateLevelDisplay();
                
                // ä¿å­˜ç”¨æˆ·æ•°æ®
                localStorage.setItem('forumUser', JSON.stringify({
                    username: currentUser,
                    messageCount: messageCount,
                    level: currentLevel,
                    exp: currentExp
                }));
                
                // æ’­æŠ¥æˆåŠŸæ¶ˆæ¯
                speechQueue.push("ç•™è¨€æˆåŠŸ");
                hasPromptedForMessage = false; // é‡ç½®æç¤ºæ ‡å¿—
                processSpeechQueue();
            } else {
                // æ²¡æœ‰æ£€æµ‹åˆ°ç•™è¨€
                speechQueue.push("æ²¡æœ‰æ£€æµ‹åˆ°ç•™è¨€ï¼Œè¯·é‡æ–°å°è¯•");
                processSpeechQueue();
            }
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°é¢‘é“
        function addMessageToChannel(channel, user, content) {
            const now = new Date();
            const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            channels[channel].push({
                user: user,
                content: content,
                time: timeString,
                type: 'user'
            });
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°DOM
        function addMessageToDOM(user, content, time, type) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${type === 'system' ? 'system-message' : ''}`;
            
            messageElement.innerHTML = `
                <div class="message-header">
                    <span class="username">${user}</span>
                    <span class="timestamp">${time}</span>
                </div>
                <div class="message-content">${content}</div>
            `;
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // æ£€æŸ¥ç­‰çº§æå‡
        function checkLevelUp() {
            if (currentLevel < levelRequirements.length - 1 && 
                currentExp >= levelRequirements[currentLevel]) {
                currentLevel++;
                speechQueue.push(`æ­å–œï¼æ‚¨çš„ç­‰çº§æå‡åˆ°${currentLevel}çº§`);
            }
        }
        
        // æ›´æ–°ç­‰çº§æ˜¾ç¤º
        function updateLevelDisplay() {
            const nextLevelExp = levelRequirements[currentLevel] - currentExp;
            levelDisplay.textContent = `Lv.${currentLevel} (${currentExp}/${levelRequirements[currentLevel]})`;
        }
        
        // è¯­éŸ³è¾“å…¥åŠŸèƒ½
        function startVoiceInput() {
            // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒè¯­éŸ³è¯†åˆ«
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'zh-CN';
                
                recognition.start();
                
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    messageInput.value = transcript;
                };
                
                recognition.onerror = (event) => {
                    alert('è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•');
                };
            } else {
                alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½");
            }
        }
        
        // åˆå§‹åŒ–åº”ç”¨
        init();
    </script>
</body>
</html>